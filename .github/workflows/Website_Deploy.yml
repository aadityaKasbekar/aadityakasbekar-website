name: Deploy Portfolio to Home Server (Cloudflare SSH)

on:
  pull_request:
    branches: [main]
    types: [closed]

jobs:
  Home_Server_Deployment:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    env:
      BIN_DEPLOY_DIR: ${{ secrets.BIN_DEPLOY_DIR }}
      CF_SERVICE_TOKEN_CLIENT_ID: ${{ secrets.CF_SERVICE_TOKEN_CLIENT_ID }}
      CF_SERVICE_TOKEN_CLIENT_SECRET: ${{ secrets.CF_SERVICE_TOKEN_CLIENT_SECRET }}
      SERVER_USER_GITHUB: ${{ secrets.SERVER_USER_GITHUB }}

    steps:
      # ------------------------------------------------------------
      # Phase1 — Checkout & build (UNCHANGED)
      # ------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build React app
        run: npm run build

      - name: Detect build output directory
        id: builddir
        shell: bash
        run: |
          set -e
          if [ -d "build" ] && [ -f "build/index.html" ]; then
            echo "dir=build" >> "$GITHUB_OUTPUT"
          elif [ -d "dist" ] && [ -f "dist/index.html" ]; then
            echo "dir=dist" >> "$GITHUB_OUTPUT"
          else
            echo "ERROR: Could not find React build output"
            exit 1
          fi

      # ------------------------------------------------------------
      # Phase2 — Install cloudflared (UNCHANGED)
      # ------------------------------------------------------------
      - name: Install cloudflared
        run: |
          curl -fsSL https://pkg.cloudflare.com/cloudflare-main.gpg \
            | sudo gpg --dearmor -o /usr/share/keyrings/cloudflare-main.gpg
          echo "deb [signed-by=/usr/share/keyrings/cloudflare-main.gpg] https://pkg.cloudflare.com/cloudflared $(lsb_release -cs) main" \
            | sudo tee /etc/apt/sources.list.d/cloudflared.list
          sudo apt update
          sudo apt install -y cloudflared
          cloudflared --version

      # ------------------------------------------------------------
      # Phase3 — Configure SSH with Cloudflare Access (CHANGED)
      # ------------------------------------------------------------
      - name: Configure SSH client with Cloudflare Access
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          cat > ~/.ssh/config <<EOF
              Host home-server
                HostName ignored
                User ${SERVER_USER_GITHUB}
                StrictHostKeyChecking no
                UserKnownHostsFile /dev/null
                ProxyCommand cloudflared access ssh --hostname ssh.aadityakasbekar.com --service-token-id ${CF_SERVICE_TOKEN_CLIENT_ID} --service-token-secret ${CF_SERVICE_TOKEN_CLIENT_SECRET}
          EOF

      # - name: Debug SSH config (sanitized)
      #   run: |
      #     echo "===== ~/.ssh/config (raw, masked by GitHub) ====="
      #     cat ~/.ssh/config

      #     echo ""
      #     echo "===== ssh -G home-server (expanded view) ====="
      #     ssh -G home-server | sed -E 's/(service-token-(id|secret))[[:space:]]+[^ ]+/\1 [REDACTED]/g'

      #     # chmod 600 ~/.ssh/config

      # ------------------------------------------------------------
      # Phase4 — Upload build, switch symlink (CHANGED only where needed)
      # ------------------------------------------------------------
      - name: Upload build and activate release
        run: |
          set -e
          TIMESTAMP="$(TZ="America/Los_Angeles" date +"%Y-%m-%d_%H-%M-%S_PST")"
          RELEASE_DIR="${BIN_DEPLOY_DIR}/releases/${TIMESTAMP}_${GITHUB_SHA}"

          echo "Deploying to release directory:"
          echo "  ${RELEASE_DIR}"
          echo "Using build output dir: ${{ steps.builddir.outputs.dir }}"

          ssh home-server "mkdir -p '${RELEASE_DIR}'"

          rsync -az --delete \
            -e "ssh" \
            "${{ steps.builddir.outputs.dir }}/" \
            "home-server:${RELEASE_DIR}/"

          ssh home-server "ln -sfn '${RELEASE_DIR}' '${BIN_DEPLOY_DIR}/current'"

      # ------------------------------------------------------------
      # Phase5 — Reload nginx (UNCHANGED)
      # ------------------------------------------------------------
      - name: Reload nginx
        run: |
          ssh home-server "sudo systemctl reload nginx"

      # ------------------------------------------------------------
      # Phase6 — Verify deployment (UNCHANGED)
      # ------------------------------------------------------------
      - name: Verify site locally on server
        run: |
          ssh home-server "curl -I http://127.0.0.1:8080 | head -n 5"x
