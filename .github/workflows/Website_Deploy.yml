name: Deploy Portfolio to Home Server (Cloudflare SSH)

on:
  pull_request:
    branches: [main]
    types: [closed]

jobs:
  Home_Server_Deployment:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    env:
      BIN_DEPLOY_DIR: ${{ secrets.BIN_DEPLOY_DIR }}
      CF_SERVICE_TOKEN_CLIENT_ID: ${{ secrets.CF_SERVICE_TOKEN_CLIENT_ID }}
      CF_SERVICE_TOKEN_CLIENT_SECRET: ${{ secrets.CF_SERVICE_TOKEN_CLIENT_SECRET }}
      SERVER_USER_GITHUB: ${{ secrets.SERVER_USER_GITHUB }}
      SSH_PRIVATE_KEY: ${{ secrets.HOME_SERVER_GITHUB_USER_SSH_PVTKEY }}

    steps:
      # ------------------------------------------------------------
      # Phase 1: Build the Application
      # ------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build React app
        run: npm run build

      - name: Detect build output directory
        id: builddir
        shell: bash
        run: |
          set -e
          if [ -d "build" ] && [ -f "build/index.html" ]; then
            echo "dir=build" >> "$GITHUB_OUTPUT"
          elif [ -d "dist" ] && [ -f "dist/index.html" ]; then
            echo "dir=dist" >> "$GITHUB_OUTPUT"
          else
            echo "ERROR: Could not find React build output"
            exit 1
          fi

      # ------------------------------------------------------------
      # Phase 2: Install Cloudflare Client
      # ------------------------------------------------------------
      - name: Install cloudflared
        run: |
          curl -fsSL https://pkg.cloudflare.com/cloudflare-main.gpg \
            | sudo gpg --dearmor -o /usr/share/keyrings/cloudflare-main.gpg
          echo "deb [signed-by=/usr/share/keyrings/cloudflare-main.gpg] https://pkg.cloudflare.com/cloudflared $(lsb_release -cs) main" \
            | sudo tee /etc/apt/sources.list.d/cloudflared.list
          sudo apt update
          sudo apt install -y cloudflared

      # ------------------------------------------------------------
      # Phase 3: Configure SSH (The "New" Clean Method)
      # ------------------------------------------------------------
      - name: Configure SSH Key and Tunnel
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          # 1. Inject the Private Key from Secrets
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

          # 2. Create the Config File
          # This tells SSH: "When I type 'ssh home-server', use this Key and this Cloudflare Tunnel"
          cat > ~/.ssh/config <<EOF
              Host home-server
                HostName bot.aadityakasbekar.com
                User ${SERVER_USER_GITHUB}
                IdentityFile ~/.ssh/id_ed25519
                StrictHostKeyChecking no
                UserKnownHostsFile /dev/null
                ProxyCommand cloudflared access ssh --hostname %h --service-token-id ${CF_SERVICE_TOKEN_CLIENT_ID} --service-token-secret ${CF_SERVICE_TOKEN_CLIENT_SECRET}
          EOF

      # ------------------------------------------------------------
      # Phase 4: Deploy
      # ------------------------------------------------------------
      - name: Upload build and activate release
        run: |
          set -e
          TIMESTAMP="$(TZ="America/Los_Angeles" date +"%Y-%m-%d_%H-%M-%S_PST")"
          RELEASE_DIR="${BIN_DEPLOY_DIR}/releases/${TIMESTAMP}_${GITHUB_SHA}"

          echo "Deploying to: ${RELEASE_DIR}"

          # Clean SSH command - checks config automatically
          ssh home-server "mkdir -p '${RELEASE_DIR}'"

          # Clean Rsync command - checks config automatically
          rsync -az --delete \
            "dist/" \
            "home-server:${RELEASE_DIR}/"

          # Update Symlink
          ssh home-server \
            "ln -sfn '${RELEASE_DIR}' '${BIN_DEPLOY_DIR}/current'"

      - name: Reload nginx
        run: |
          ssh home-server "sudo systemctl reload nginx"

      - name: Verify deployment
        run: |
          ssh home-server "curl -I http://127.0.0.1:8080 | head -n 5"
